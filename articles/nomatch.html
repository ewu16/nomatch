<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>nomatch • nomatch</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="nomatch">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">nomatch</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/nomatch.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ewu16/nomatch/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>nomatch</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ewu16/nomatch/blob/main/vignettes/nomatch.Rmd" class="external-link"><code>vignettes/nomatch.Rmd</code></a></small>
      <div class="d-none name"><code>nomatch.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The <code>nomatch</code> package is designed to use G-computation
style estimation to compute estimates of marginal cumulative incidence
in observational cohort studies with a binary exposure and a
time-to-event outcome. The approach aligns with the target trial
emulation framework (Hernan 2016) and provides an alternative to
matching methods, which can suffer from substantial efficiency loss.
Estimation involves fitting two exposure-specific Cox models which
adjust for baseline confounders. Predictions from these models are used
to compute marginal cumulative incidence under interventions of exposure
and no exposure. Effect measures such as risk differences, risk ratios,
and relative risk reduction are also provided.</p>
</div>
<div class="section level2">
<h2 id="usage">Usage<a class="anchor" aria-label="anchor" href="#usage"></a>
</h2>
<p>We examine the use of <code>nomatch</code> to produce estimates of
effectiveness for a binary exposure. The package can be loaded as
follows:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ewu16.github.io/nomatch/">nomatch</a></span><span class="op">)</span></span></code></pre></div>
<p>We will illustrate the use of the package using a simple simulated
dataset, <code>simdata</code>, included in the package. For exposition,
we will assume this dataset represents data from an observational
vaccine study. In practice, data from other disease settings can be used
as well. The first few rows of <code>simdata</code> can be viewed as
follows:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simdata</span> <span class="op">&lt;-</span> <span class="fu">as_tibble</span><span class="op">(</span><span class="va">simdata</span><span class="op">)</span> <span class="co">#for prettier printing</span></span>
<span></span>
<span><span class="co">#View data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">simdata</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 7</span></span></span>
<span><span class="co">#&gt;      ID    x1    x2     V D_obs     Y event</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>     1     1     7     1     2    92     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>     2     0     7     0    <span style="color: #BB0000;">NA</span>   210     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>     3     0    11     1    35   210     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>     4     0    10     1     6   210     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>     5     1    11     0    <span style="color: #BB0000;">NA</span>   210     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span>     6     1     7     0    <span style="color: #BB0000;">NA</span>    90     0</span></span></code></pre></div>
<p>The data contains one row per individual (<code>ID</code>) and a set
of individual baseline covariates (<code>x1</code>, <code>x2</code>).
Information on an individual’s exposure is encompassed in 1) their
vaccination status (<code>V</code>), a binary indicator with values
<code>1 = vaccinated, 0 = unvaccinated</code> and 2) their time to
receiving vaccination (<code>D_obs</code>), a numeric value for
vaccinated individuals and <code>NA</code> for unvaccinated individuals.
The data also includes right-censored survival
outcomes<code>(Y, event)</code> where <code>Y</code> represents
follow-up time for an outcome (e.g. infection or death), and
<code>event</code> indicates whether the individual experienced the
event with values <code>1 = event, 0 = censored</code>.</p>
<p>We will assume that time to vaccination <code>D_obs</code> and time
to outcome <code>Y</code> are measured relative to a calendar date of
study start because calendar time is often an important time scale in
vaccine studies due to changing infection dynamics. In other settings,
the relevant time scale may be time since enrollment or other meaningful
event, or age. Regardless of the choice of time scale, the same time
origin should be used to define the time to exposure and time to outcome
variables, as well as the baseline covariates.</p>
<div class="section level3">
<h3 id="estimating-cumulative-incidence">Estimating cumulative incidence<a class="anchor" aria-label="anchor" href="#estimating-cumulative-incidence"></a>
</h3>
<p>To learn about the real-world effectiveness of an intervention, we
can try to compare the incidence of the endpoint of interest at a fixed
time after exposure when individuals are assigned to an active or
control exposure. We will assume that the exposed group consists of
initiators (e.g vaccinated individuals) and that the non-exposed group
consists of non-initiators (e.g. unvaccinated individuals). An
analytical challenge in this setting is that the start of follow-up for
the unexposed group is not well-defined. One way to circumvent this
issue is to imagine that we can assign individuals in a certain
covariate group to receive an exposure (or no exposure) on a certain
day. In this case, the natural start of follow-up is the assigned day
for receiving the exposure, just as start of follow-up in a randomized
trial is the day of randomization. This allows us to define cumulative
incidences for each intervention-day and for each covariate group. These
day- and covariate-specific cumulative incidences can then be
marginalized (e.g. over the distribution of exposure days and covariates
among those observed to be exposed) to obtain overall cumulative
incidence estimates.</p>
<p>We can invoke the <code>nomatch</code> function to compute these
marginal cumulative incidences. Here, we need to provide several types
of arguments:</p>
<ul>
<li><p><code>data, outcome_time, outcome_status, exposure, exposure_time, covariates</code>:
Primary arguments providing the dataset and the names of the variables
in the dataset that describe the outcome, exposure, and covariates to
adjust for.</p></li>
<li><p><code>immune_lag, timepoints</code>: Arguments that specify what
cumulative incidences to compute. The first, <code>immune_lag</code>, is
used to compute cumulative incidences that ignore events that occur
within <code>immune_lag</code> days; the population of interest is
defined to be the subset of individuals who would remain endpoint-free
<code>immune_lag</code> days after exposure. This is often used in
vaccine studies because the vaccine takes time to induce an immune
response and become effective. We will set <code>immune_lag = 14</code>
(2 weeks) for our pretend vaccine study, but this can also be set to
<code>0</code> when not relevant to the setting of interest. The second,
<code>timepoints</code>, specifies the timepoints of interest for
evaluating cumulative incidence. Here we’ve specified to compute the
cumulative incidence of infection/severity outcomes occurring within
<code>30, 60, 90, ..180</code> days after vaccination.</p></li>
<li><p><code>boot_reps</code>: Argument for the number of bootstrap
replications to use since confidence intervals for the estimated
cumulative incidences and effect measures are based on bootstrapping
procedures. Note that we use a small number here so the example runs
quicly, but <code>boot_reps = 1000</code> is recommended to construct
reliable confidence intervals for interpretation. By default, Wald-style
bootstrap confidence intervals and p-values are returned.</p></li>
</ul>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Compute cumulative incidence </span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nomatch.html">nomatch</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">simdata</span>,</span>
<span>               outcome_time <span class="op">=</span> <span class="st">"Y"</span>,</span>
<span>               outcome_status <span class="op">=</span> <span class="st">"event"</span>,</span>
<span>               exposure <span class="op">=</span> <span class="st">"V"</span>,</span>
<span>               exposure_time <span class="op">=</span> <span class="st">"D_obs"</span>, </span>
<span>               covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x1"</span>, <span class="st">"x2"</span><span class="op">)</span>,</span>
<span>               immune_lag <span class="op">=</span> <span class="fl">14</span>,</span>
<span>               timepoints <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">180</span>, by <span class="op">=</span> <span class="fl">30</span><span class="op">)</span>,</span>
<span>               boot_reps <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; Bootstrapping 10 samples...</span></span>
<span><span class="co">#&gt; Time difference of 3.47804 secs</span></span></code></pre></div>
<p>We can print the relative risk reduction (i.e vaccine effectiveness)
estimates for our simulated dataset.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit</span>, effect <span class="op">=</span> <span class="st">"relative_risk_reduction"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Relative Risk Reduction Estimates </span></span>
<span><span class="co">#&gt; ================================================== </span></span>
<span><span class="co">#&gt; Call: nomatch(data = simdata, outcome_time = "Y", outcome_status = "event", </span></span>
<span><span class="co">#&gt;     exposure = "V", exposure_time = "D_obs", covariates = c("x1", </span></span>
<span><span class="co">#&gt;         "x2"), immune_lag = 14, timepoints = seq(30, 180, by = 30), </span></span>
<span><span class="co">#&gt;     boot_reps = 10) </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Result:</span></span>
<span><span class="co">#&gt;   Timepoint Estimate 95% Wald CI: Lower 95% Wald CI: Upper Wald p-value</span></span>
<span><span class="co">#&gt; 1        30    0.466             0.0902              0.686     0.086340</span></span>
<span><span class="co">#&gt; 2        60    0.395             0.2359              0.521     0.000925</span></span>
<span><span class="co">#&gt; 3        90    0.397             0.2594              0.508     0.000148</span></span>
<span><span class="co">#&gt; 4       120    0.339             0.2011              0.453     0.000448</span></span>
<span><span class="co">#&gt; 5       150    0.269             0.1387              0.380     0.001338</span></span>
<span><span class="co">#&gt; 6       180    0.172             0.0444              0.283     0.018627</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Use summary() for more details</span></span>
<span><span class="co">#&gt; Use plot() to visualize results</span></span></code></pre></div>
<p>The cumulative incidence estimates (<code>cuminc_0</code> for
unexposed and <code>cuminc_1</code> for exposed) ) and other effects
(<code>risk_difference</code>, <code>risk_ratio</code>, and
<code>relative_risk_reduction</code>) are also stored within the fitted
object. These can be examined via <code>fit$estimates</code>.</p>
<p>If all confounders are adjusted for, the resulting cumulative
incidence/effect estimates can be interpreted as the cumulative
incidences or effect that would be observed in a clinical trial in which
participants 1) are similar to those observed to be exposed and 2) who
enroll into the study such that the distribution of enrollments times
matches the distribution of observed exposure times.</p>
</div>
<div class="section level3">
<h3 id="additional-details-about-estimation-approach">Additional details about estimation approach<a class="anchor" aria-label="anchor" href="#additional-details-about-estimation-approach"></a>
</h3>
<p>Internally, the cumulative incidence estimates are computed by
fitting two Cox models- one model for the unexposed and one model for
the exposed. In the model for the unexposed, time to the endpoint of
interest is measured relative to the study start (or chosen time
origin). The unexposed model includes all individuals, where exposed
individuals are censored at the time of exposure, and adjusts for
covariates. In the model for the exposed, the time to endpoint of
interest is measured relative to the time of exposure. The model
includes all exposed individuals at risk <code>immune_lag</code> days
after exposure, flexibly adjusting for the time of exposure (by default,
using natural cubic splines with four degrees of freedom), as well
baseline covariates. A summary of the estimation approach and fitted
models can be obtained by</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ====================================================================== </span></span>
<span><span class="co">#&gt; Analysis Summary</span></span>
<span><span class="co">#&gt; ====================================================================== </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Method:              nomatch (G-computation) </span></span>
<span><span class="co">#&gt; Evaluation times:    30, 60, 90, 120, 150, 180  </span></span>
<span><span class="co">#&gt; Immune lag:          14 </span></span>
<span><span class="co">#&gt; Adjusted for:        x1, x2 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Bootstrap:           10 replicates</span></span>
<span><span class="co">#&gt; Confidence level:    95 %</span></span>
<span><span class="co">#&gt; Successful samples:  10-10  (range across timepoints)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ---------------------------------------------------------------------- </span></span>
<span><span class="co">#&gt; Sample:</span></span>
<span><span class="co">#&gt; ---------------------------------------------------------------------- </span></span>
<span><span class="co">#&gt; N total: 10000 </span></span>
<span><span class="co">#&gt; Number of events: 1007 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; N exposed: 4112 </span></span>
<span><span class="co">#&gt; N exposed at-risk &lt;immune_lag&gt; days after exposure: 4045 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Distribution of exposure times among at-risk &lt;immune_lag&gt; days after exposure:</span></span>
<span><span class="co">#&gt;  Range:  1 - 194 |  Median (IQR):  18 (11 - 32) |  Mean:  25.5</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ---------------------------------------------------------------------- </span></span>
<span><span class="co">#&gt; Model for unexposed:</span></span>
<span><span class="co">#&gt; ---------------------------------------------------------------------- </span></span>
<span><span class="co">#&gt; N = 10000 | Number of events = 664 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Use '$model_0' to see model details.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ---------------------------------------------------------------------- </span></span>
<span><span class="co">#&gt; Model for exposed:</span></span>
<span><span class="co">#&gt; ---------------------------------------------------------------------- </span></span>
<span><span class="co">#&gt; N = 4045 | Number of events = 265 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Use '$model_1' to see model details.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ======================================================================</span></span></code></pre></div>
<p>These Cox models are used to predict day and covariate specific
cumulative incidences which are then, by default, marginalized over the
observed distribution of exposure times and covariates in the exposed.
The weights used for marginalization are returned in the
<code>$weights</code> component of the fitted object.</p>
</div>
<div class="section level3">
<h3 id="plotting-cumulative-incidence-curves">Plotting cumulative incidence curves<a class="anchor" aria-label="anchor" href="#plotting-cumulative-incidence-curves"></a>
</h3>
<p>We can make a quick panel plot of the cumulative incidence and
vaccine effectiveness estimates over time using <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code>.
Note that if cumulative incidence curves are of interest, it is
recommended to provide a fine grid of <code>timepoints</code> to produce
smooth curves. Our example plot will be somewhat crude due to the small
number of timepoints used in the function call.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit</span>, effect <span class="op">=</span> <span class="st">"relative_risk_reduction"</span><span class="op">)</span></span></code></pre></div>
<p><img src="nomatch_files/figure-html/unnamed-chunk-6-1.png" class="r-plt" width="576"></p>
<div class="section level4">
<h4 id="plotting-simultaneous-confidence-intervals">Plotting simultaneous confidence intervals<a class="anchor" aria-label="anchor" href="#plotting-simultaneous-confidence-intervals"></a>
</h4>
<p>Note that in the plot above, we have plotted the pointwise confidence
intervals, which are just the usual 95% confidence intervals plotted at
each timepoint. If we would instead like to make inference on the entire
curve, we need to construct simultaneous confidence intervals. We can do
this using the <code>add_simulatenous_ci()</code> function which
computes simultaneous confidence intervals given an existing fitted
object, provided that the bootstrap samples were saved in the object
(i.e. <code>keep_boot_samples = TRUE</code>, the default). This function
returns the original fitted object updated with simultaneous confidence
intervals which we now save in a new object.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Compute simultaneous CI</span></span>
<span><span class="va">fit_with_simul</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/add_simultaneous_ci.html">add_simultaneous_ci</a></span><span class="op">(</span><span class="va">fit</span>, seed <span class="op">=</span> <span class="fl">1234</span><span class="op">)</span></span></code></pre></div>
<p>The simultaneous confidence intervals are now stored in the fitted
object.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_with_simul</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Risk Ratio Estimates </span></span>
<span><span class="co">#&gt; ================================================== </span></span>
<span><span class="co">#&gt; Call: nomatch(data = simdata, outcome_time = "Y", outcome_status = "event", </span></span>
<span><span class="co">#&gt;     exposure = "V", exposure_time = "D_obs", covariates = c("x1", </span></span>
<span><span class="co">#&gt;         "x2"), immune_lag = 14, timepoints = seq(30, 180, by = 30), </span></span>
<span><span class="co">#&gt;     boot_reps = 10) </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Result:</span></span>
<span><span class="co">#&gt;   Timepoint Estimate 95% Wald CI: Lower 95% Wald CI: Upper Wald p-value</span></span>
<span><span class="co">#&gt; 1        30    0.534              0.314              0.910     0.086340</span></span>
<span><span class="co">#&gt; 2        60    0.605              0.479              0.764     0.000925</span></span>
<span><span class="co">#&gt; 3        90    0.603              0.492              0.741     0.000148</span></span>
<span><span class="co">#&gt; 4       120    0.661              0.547              0.799     0.000448</span></span>
<span><span class="co">#&gt; 5       150    0.731              0.620              0.861     0.001338</span></span>
<span><span class="co">#&gt; 6       180    0.828              0.717              0.956     0.018627</span></span>
<span><span class="co">#&gt;   95% Simul CI: Lower 95% Simul CI: Upper</span></span>
<span><span class="co">#&gt; 1               0.282               1.012</span></span>
<span><span class="co">#&gt; 2               0.457               0.801</span></span>
<span><span class="co">#&gt; 3               0.472               0.772</span></span>
<span><span class="co">#&gt; 4               0.527               0.830</span></span>
<span><span class="co">#&gt; 5               0.600               0.890</span></span>
<span><span class="co">#&gt; 6               0.697               0.983</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Use summary() for more details</span></span>
<span><span class="co">#&gt; Use plot() to visualize results</span></span></code></pre></div>
<p>We can also plot the cumulative incidence curves with simultaneous
confidence intervals by providing the <code>ci_type</code> argument.
Note that the simultaneous confidence intervals must be computed before
plotting; otherwise, the call will error.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Plot simultaneous confidence bands </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit_with_simul</span> , effect <span class="op">=</span> <span class="st">"relative_risk_reduction"</span>, ci_type <span class="op">=</span> <span class="st">"simul"</span><span class="op">)</span> </span></code></pre></div>
<p><img src="nomatch_files/figure-html/unnamed-chunk-9-1.png" class="r-plt" width="576"></p>
<p>The simultaneous confidence intervals indicate that if we were to
repeatedly construct simultaneous confidence intervals on new samples of
data, then 95% of the constructed simultaneous confidence bands would
contain the true cumulative inicdence/effectiveness curve.</p>
</div>
</div>
<div class="section level3">
<h3 id="creating-custom-plots">Creating custom plots<a class="anchor" aria-label="anchor" href="#creating-custom-plots"></a>
</h3>
<p>Often, users may wish to create their own custom plots. This can be
done by extracting the estimates from the fitted object and creating a
long tidy-style data frame. The utility function
<code><a href="../reference/estimates_to_df.html">estimates_to_df()</a></code> takes the <code>estimates</code>
component of the fitted object and reformats it as a long dataset that
can be used for plotting.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/estimates_to_df.html">estimates_to_df</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu">as_tibble</span><span class="op">(</span><span class="va">plot_data</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 8</span></span></span>
<span><span class="co">#&gt;      t0 term             estimate wald_lower wald_upper wald_se wald_pval wald_n</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>               <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>    30 cuminc_0          0.011<span style="text-decoration: underline;">6</span>     0.009<span style="text-decoration: underline;">42</span>    0.014<span style="text-decoration: underline;">4</span>  0.109     <span style="color: #BB0000;">NA</span>          10</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>    30 cuminc_1          0.006<span style="text-decoration: underline;">22</span>    0.004<span style="text-decoration: underline;">19</span>    0.009<span style="text-decoration: underline;">22</span> 0.202     <span style="color: #BB0000;">NA</span>          10</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>    30 risk_difference  -<span style="color: #BB0000;">0.005</span><span style="color: #BB0000; text-decoration: underline;">42</span>   -<span style="color: #BB0000;">0.009</span><span style="color: #BB0000; text-decoration: underline;">81</span>   -<span style="color: #BB0000;">0.001</span><span style="color: #BB0000; text-decoration: underline;">03</span> 0.002<span style="text-decoration: underline;">24</span>    0.015<span style="text-decoration: underline;">5</span>     10</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>    30 risk_ratio        0.534      0.314      0.910   0.271      0.086<span style="text-decoration: underline;">3</span>     10</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>    30 relative_risk_r…  0.466      0.090<span style="text-decoration: underline;">2</span>     0.686   0.271      0.086<span style="text-decoration: underline;">3</span>     10</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span>    60 cuminc_0          0.037<span style="text-decoration: underline;">9</span>     0.033<span style="text-decoration: underline;">0</span>     0.043<span style="text-decoration: underline;">5</span>  0.073<span style="text-decoration: underline;">7</span>    <span style="color: #BB0000;">NA</span>          10</span></span></code></pre></div>
<p>For example, we can create a plot that overlays the cumulative
incidence estimates for the two exposure types as follows:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_data</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">term</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cuminc_0"</span>, <span class="st">"cuminc_1"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">t0</span>, y <span class="op">=</span> <span class="va">estimate</span>, color <span class="op">=</span> <span class="va">term</span>, fill <span class="op">=</span> <span class="va">term</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_ribbon</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">wald_lower</span>, ymax <span class="op">=</span> <span class="va">wald_upper</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.2</span>, linewidth <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_discrete</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cuminc_0"</span>, <span class="st">"cuminc_1"</span><span class="op">)</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Unvaccinated"</span>, <span class="st">"Vaccinated"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">scale_fill_discrete</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cuminc_0"</span>, <span class="st">"cuminc_1"</span><span class="op">)</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Unvaccinated"</span>, <span class="st">"Vaccinated"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span> </span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Time since vaccination"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Estimate"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Cumulative Incidence Curves"</span>, </span>
<span>       color <span class="op">=</span> <span class="st">"Exposure Group"</span>,</span>
<span>       fill <span class="op">=</span> <span class="st">"Exposure Group"</span><span class="op">)</span></span></code></pre></div>
<p><img src="nomatch_files/figure-html/unnamed-chunk-11-1.png" class="r-plt" width="576"></p>
</div>
<div class="section level3">
<h3 id="comparison-with-matching">Comparison with matching<a class="anchor" aria-label="anchor" href="#comparison-with-matching"></a>
</h3>
<p>The G-computation estimation approach is generally expected to
produce similar point estimates as a simple analysis using
rolling-cohort matching in which exposed individuals are matched to an
eligible unexposed individual at their time of exposure on key
covariates. An advantage of the G-computation estimation approach is
that it offers greater precision, which may be pecially valuable when
the data involves smaller samples sizes or rare endpoints. To aid
comparison of the two approaches, we provide a simple implementation of
a matching approach that uses a rolling cohort design with 1:1 exact
matching and Kaplan Meier estimation for computing marginal cumulative
incidences. Note that the functions for implementing matching may take a
while to run on large datasets. They are also intentionally limited in
scope, serving only to provide a simple matching comparison.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ------------------------------------------------------------------------------</span></span>
<span><span class="co"># 3. Compare results with matching estimator</span></span>
<span></span>
<span><span class="va">matched_cohort</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/match_rolling_cohort.html">match_rolling_cohort</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">simdata</span>,</span>
<span>                                       outcome_time <span class="op">=</span> <span class="st">"Y"</span>,</span>
<span>                                       exposure <span class="op">=</span> <span class="st">"V"</span>,</span>
<span>                                       exposure_time <span class="op">=</span> <span class="st">"D_obs"</span>, </span>
<span>                                       matching_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x1"</span>, <span class="st">"x2"</span><span class="op">)</span>,</span>
<span>                                       id_name <span class="op">=</span> <span class="st">"ID"</span>,</span>
<span>                                       seed <span class="op">=</span> <span class="fl">5678</span><span class="op">)</span></span>
<span></span>
<span><span class="va">matched_data</span> <span class="op">&lt;-</span> <span class="va">matched_cohort</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span></span>
<span><span class="va">fit_matching</span> <span class="op">&lt;-</span><span class="fu"><a href="../reference/matching.html">matching</a></span><span class="op">(</span>matched_data <span class="op">=</span> <span class="va">matched_data</span>,</span>
<span>                        outcome_time <span class="op">=</span> <span class="st">"Y"</span>,</span>
<span>                        outcome_status <span class="op">=</span> <span class="st">"event"</span>,</span>
<span>                        exposure <span class="op">=</span> <span class="st">"V"</span>,</span>
<span>                        exposure_time <span class="op">=</span> <span class="st">"D_obs"</span>, </span>
<span>                        immune_lag <span class="op">=</span> <span class="fl">14</span>,</span>
<span>                        timepoints <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">180</span>, by <span class="op">=</span> <span class="fl">30</span><span class="op">)</span>,</span>
<span>                        boot_reps <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> </span>
<span><span class="co">#&gt; Bootstrapping 10 samples...</span></span>
<span><span class="co">#&gt; Time difference of 1.429927 secs</span></span>
<span></span>
<span><span class="va">fit_matching</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Risk Ratio Estimates </span></span>
<span><span class="co">#&gt; ================================================== </span></span>
<span><span class="co">#&gt; Call: matching(matched_data = matched_data, outcome_time = "Y", outcome_status = "event", </span></span>
<span><span class="co">#&gt;     exposure = "V", exposure_time = "D_obs", immune_lag = 14, </span></span>
<span><span class="co">#&gt;     timepoints = seq(30, 180, by = 30), boot_reps = 10) </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Result:</span></span>
<span><span class="co">#&gt;   Timepoint Estimate 95% Wald CI: Lower 95% Wald CI: Upper Wald p-value</span></span>
<span><span class="co">#&gt; 1        30    0.497              0.218              1.137      0.23324</span></span>
<span><span class="co">#&gt; 2        60    0.517              0.374              0.715      0.00346</span></span>
<span><span class="co">#&gt; 3        90    0.611              0.413              0.905      0.05192</span></span>
<span><span class="co">#&gt; 4       120    0.671              0.499              0.904      0.03018</span></span>
<span><span class="co">#&gt; 5       150    0.710              0.571              0.884      0.00935</span></span>
<span><span class="co">#&gt; 6       180    0.775              0.616              0.976      0.05517</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Use summary() for more details</span></span>
<span><span class="co">#&gt; Use plot() to visualize results</span></span>
<span></span>
<span><span class="co"># Plot matching vs proposed estimator - nomatch tends to have similar point estimates but narrower</span></span>
<span><span class="co"># confidence intervals</span></span>
<span><span class="fu"><a href="../reference/compare_ve_fits.html">compare_ve_fits</a></span><span class="op">(</span><span class="va">fit_matching</span>, <span class="va">fit</span>, effect <span class="op">=</span> <span class="st">"relative_risk_reduction"</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Matching"</span>, <span class="st">"nomatch (G-computation)"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="nomatch_files/figure-html/unnamed-chunk-12-1.png" class="r-plt" width="576"></p>
</div>
</div>
<div class="section level2">
<h2 id="session-information">Session Information<a class="anchor" aria-label="anchor" href="#session-information"></a>
</h2>
<pre><code><span><span class="co">#&gt; R version 4.5.2 (2025-10-31)</span></span>
<span><span class="co">#&gt; Platform: x86_64-pc-linux-gnu</span></span>
<span><span class="co">#&gt; Running under: Ubuntu 24.04.3 LTS</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Matrix products: default</span></span>
<span><span class="co">#&gt; BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3 </span></span>
<span><span class="co">#&gt; LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.26.so;  LAPACK version 3.12.0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; locale:</span></span>
<span><span class="co">#&gt;  [1] LC_CTYPE=C.UTF-8       LC_NUMERIC=C           LC_TIME=C.UTF-8       </span></span>
<span><span class="co">#&gt;  [4] LC_COLLATE=C.UTF-8     LC_MONETARY=C.UTF-8    LC_MESSAGES=C.UTF-8   </span></span>
<span><span class="co">#&gt;  [7] LC_PAPER=C.UTF-8       LC_NAME=C              LC_ADDRESS=C          </span></span>
<span><span class="co">#&gt; [10] LC_TELEPHONE=C         LC_MEASUREMENT=C.UTF-8 LC_IDENTIFICATION=C   </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; time zone: UTC</span></span>
<span><span class="co">#&gt; tzcode source: system (glibc)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; attached base packages:</span></span>
<span><span class="co">#&gt; [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; other attached packages:</span></span>
<span><span class="co">#&gt; [1] nomatch_0.0.0.9000 dplyr_1.1.4        ggplot2_4.0.1      tibble_3.3.0      </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; loaded via a namespace (and not attached):</span></span>
<span><span class="co">#&gt;  [1] Matrix_1.7-4       gtable_0.3.6       jsonlite_2.0.0     compiler_4.5.2    </span></span>
<span><span class="co">#&gt;  [5] tidyselect_1.2.1   parallel_4.5.2     jquerylib_0.1.4    splines_4.5.2     </span></span>
<span><span class="co">#&gt;  [9] systemfonts_1.3.1  scales_1.4.0       textshaping_1.0.4  ggh4x_0.3.1       </span></span>
<span><span class="co">#&gt; [13] yaml_2.3.11        fastmap_1.2.0      lattice_0.22-7     R6_2.6.1          </span></span>
<span><span class="co">#&gt; [17] labeling_0.4.3     generics_0.1.4     knitr_1.50         MASS_7.3-65       </span></span>
<span><span class="co">#&gt; [21] desc_1.4.3         bslib_0.9.0        pillar_1.11.1      RColorBrewer_1.1-3</span></span>
<span><span class="co">#&gt; [25] rlang_1.1.6        utf8_1.2.6         cachem_1.1.0       xfun_0.54         </span></span>
<span><span class="co">#&gt; [29] fs_1.6.6           sass_0.4.10        S7_0.2.1           cli_3.6.5         </span></span>
<span><span class="co">#&gt; [33] pkgdown_2.2.0      withr_3.0.2        magrittr_2.0.4     digest_0.6.39     </span></span>
<span><span class="co">#&gt; [37] grid_4.5.2         lifecycle_1.0.4    vctrs_0.6.5        evaluate_1.0.5    </span></span>
<span><span class="co">#&gt; [41] glue_1.8.0         farver_2.1.2       ragg_1.5.0         survival_3.8-3    </span></span>
<span><span class="co">#&gt; [45] rmarkdown_2.30     tools_4.5.2        pkgconfig_2.0.3    htmltools_0.5.9</span></span></code></pre>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Emily Wu.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
